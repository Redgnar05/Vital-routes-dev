{% extends "base.html" %}
{% block content %}

<!-- ===================================== -->
<!-- ENCABEZADO DEL DASHBOARD -->
<!-- ===================================== -->
<section class="dashboard-header">
  <h2>Hola, {{ username }} ðŸ‘‹</h2>

  <p>
    <a href="{{ url_for('update_profile') }}" class="btn-main">
      Actualizar datos personales
    </a>
  </p>

  <p>Consulta una ciudad para evaluar condiciones ambientales</p>
</section>


<!-- ===================================== -->
<!-- FORMULARIO PARA ANALIZAR CIUDAD -->
<!-- ===================================== -->
<section class="card">
  <form method="POST" action="{{ url_for('dashboard') }}" class="form">
    <label for="ciudad">Ciudad:</label>
    <input type="text" id="ciudad" name="ciudad" placeholder="Ejemplo: Ciudad de MÃ©xico">
    <button type="submit" class="btn-main">Analizar</button>
  </form>

  {% if error %}
    <div class="alert alert-error">{{ error }}</div>
  {% endif %}
</section>


<!-- ===================================== -->
<!-- RESULTADOS AMBIENTALES (si hubo POST) -->
<!-- ===================================== -->
{% if resultado %}
<section class="card">
  <h2>Resultados para {{ resultado.ciudad }}</h2>

  <div class="grid">

    <!-- CLIMA -->
    <div class="box">
      <h3>Clima</h3>
      <p><strong>CondiciÃ³n:</strong> {{ resultado.clima.descripcion }}</p>
      <p><strong>Temperatura:</strong> {{ resultado.clima.temp }} Â°C</p>
      <p><strong>Humedad:</strong> {{ resultado.clima.humedad }} %</p>
    </div>

    <!-- AIRE -->
    <div class="box">
      <h3>Calidad del aire (simulada)</h3>
      <p><strong>PM2.5:</strong> {{ resultado.aire.pm25 }} Âµg/mÂ³</p>
      <p><strong>PM10:</strong> {{ resultado.aire.pm10 }} Âµg/mÂ³</p>
      <p><strong>AQI:</strong> {{ resultado.aire.aqi }} ({{ resultado.aire.categoria }})</p>
    </div>

    <!-- RUIDO -->
    <div class="box">
      <h3>Ruido (simulado)</h3>
      <p><strong>Nivel:</strong> {{ resultado.ruido.ruido_db }} dB</p>
      <p><strong>Fuente probable:</strong> {{ resultado.ruido.fuente_probable }}</p>
    </div>

  </div>

  <!-- RIESGO GLOBAL -->
  <div class="riesgo riesgo-{{ resultado.riesgo.color }}">
    <h3>Riesgo global para la salud: {{ resultado.riesgo.nivel }}</h3>
    <p>PuntuaciÃ³n interna: {{ resultado.riesgo.score }}</p>
  </div>

  <!-- RECOMENDACIONES -->
  <section class="recomendaciones">
    <h3>Recomendaciones</h3>
    <ul>
      {% for rec in resultado.recomendaciones %}
        <li>{{ rec }}</li>
      {% endfor %}
    </ul>

    <p class="sugerencia">
      <strong>Horario sugerido:</strong> {{ resultado.sugerencia_horario }}
    </p>
  </section>

</section>
{% endif %}



<!-- ===================================== -->
<!-- PERFIL DEL USUARIO (solo si riesgo existe) -->
<!-- ===================================== -->
{% if riesgo is not none %}
<section class="perfil-usuario">
    <h2 class="titulo-seccion">Tu perfil de salud</h2>

    <div class="perfil-grid">

        <!-- DATOS PERSONALES -->
        <div class="perfil-box">
            <h3><i class="fa-solid fa-user"></i> Datos personales</h3>
            <p><strong>Edad:</strong> {{ user.edad }}</p>
            <p><strong>Sexo:</strong> {{ user.sexo }}</p>
            <p><strong>Actividad fÃ­sica:</strong> {{ user.actividad }}</p>
            <p><strong>Tiempo al aire libre:</strong> {{ user.aire_libre }}</p>
            <p><strong>Transporte:</strong> {{ user.transporte }}</p>
        </div>

        <!-- CONDICIONES MÃ‰DICAS -->
        <div class="perfil-box">
            <h3><i class="fa-solid fa-heart-circle-exclamation"></i> Condiciones de salud</h3>
            <ul>
                {% if user.asma == "Si" %}<li>Asma</li>{% endif %}
                {% if user.respiratorio == "Si" %}<li>Problemas respiratorios</li>{% endif %}
                {% if user.alergias == "Si" %}<li>Alergias</li>{% endif %}
                {% if user.hipertension == "Si" %}<li>HipertensiÃ³n</li>{% endif %}
                {% if user.diabetes == "Si" %}<li>Diabetes</li>{% endif %}

                {% if user.asma != "Si"
                      and user.respiratorio != "Si"
                      and user.alergias != "Si"
                      and user.hipertension != "Si"
                      and user.diabetes != "Si" %}
                    <li>Sin condiciones registradas</li>
                {% endif %}
            </ul>
        </div>

        <!-- SENSIBILIDADES -->
        <div class="perfil-box">
            <h3><i class="fa-solid fa-temperature-half"></i> Sensibilidades ambientales</h3>
            <ul>
                {% if user.sensible_calor == "Si" %}<li>Sensible al calor</li>{% endif %}
                {% if user.sensible_frio == "Si" %}<li>Sensible al frÃ­o</li>{% endif %}
                {% if user.sensibilidad_ruido == "Si" %}<li>Sensible al ruido</li>{% endif %}
                {% if user.sensibilidad_contaminacion == "Si" %}<li>Sensible a la contaminaciÃ³n</li>{% endif %}

                {% if user.sensible_calor != "Si"
                      and user.sensible_frio != "Si"
                      and user.sensibilidad_ruido != "Si"
                      and user.sensibilidad_contaminacion != "Si" %}
                    <li>Sin sensibilidades registradas</li>
                {% endif %}
            </ul>
        </div>

        <!-- BARRA DE RIESGO PERSONAL -->
        <div class="perfil-box full-width">
            <h3><i class="fa-solid fa-triangle-exclamation"></i> Nivel de riesgo personal</h3>

            <div class="barra-riesgo">
                {% if riesgo is not none %}
                <div class="nivel {{ riesgo.color }}"
                     style="width: {{ riesgo.score * 5 }}%;"></div>
                {% endif %}
            </div>

            {% if riesgo is not none %}
            <p class="riesgo-text">
                Riesgo global: <strong>{{ riesgo.nivel }}</strong>
                (puntaje {{ riesgo.score }})
            </p>
            {% endif %}
        </div>

    </div>
</section>
{% endif %}

{% endblock %}
